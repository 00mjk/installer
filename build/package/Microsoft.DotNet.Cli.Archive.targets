<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" DefaultTargets="Layout" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <UsingTask TaskName="ArchiveDirectory" AssemblyFile="$(CLIBuildDll)" />

  <Target Name="SetupGenerateArchivesInputsOutputs" DependsOnTargets="Init">
    <PropertyGroup>
      <ArchiveOutputDirectory>$(PackagesDirectory)</ArchiveOutputDirectory>
    </PropertyGroup>

    <ItemGroup>
      <GeneratedArchives Include="$(ArchiveOutputDirectory)/%(LayoutDefinition.NameWithVersion)$(ArchiveExtension)" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateArchives" 
          DependsOnTargets="Init;Layout;SetupGenerateArchivesInputsOutputs" 
          Inputs="@(LayoutDefinition -> '$(LayoutDirectory)/%(Name)')" 
          Outputs="@(GeneratedArchives -> '%(Identity)')">

    <ArchiveDirectory
        FileName="%(LayoutDefinition.NameWithVersion)"
        OutputDirectory="$(ArchiveOutputDirectory)"
        InputDirectory="$(LayoutDirectory)/%(LayoutDefinition.Name)" >

        <Output TaskParameter="OutputArchive"
                ItemName="Archives" />
    </ArchiveDirectory>

  </Target>

</Project>
