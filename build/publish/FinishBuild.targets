<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="FinishBuild"
          Condition="'$(IsOrchestratedPublish)' != 'true'"
          DependsOnTargets="SetArtifactBlobProps;
                            SetChecksumBlobProps;
                            CheckIfAllBuildsHavePublished;
                            FinalizeBuild" />

  <Target Name="SetArtifactBlobProps">
    <Error Condition="'$(ArtifactCloudDropURL)' == ''" Text="Missing property ArtifactCloudDropURL." />

    <ParseBlobUrl FeedUrl="$(ArtifactCloudDropURL)">
      <Output TaskParameter="BlobElements" ItemName="BlobElements" />
    </ParseBlobUrl>

    <PropertyGroup>
      <ArtifactBlobContainerName>%(BlobElements.ContainerName)</ArtifactBlobContainerName>
      <ArtifactBlobAccountName>%(BlobElements.AccountName)</ArtifactBlobAccountName>
    </PropertyGroup>
  </Target>

  <Target Name="SetChecksumBlobProps">
    <Error Condition="'$(ChecksumCloudDropURL)' == ''" Text="Missing property ChecksumCloudDropURL." />

    <ParseBlobUrl FeedUrl="$(ChecksumCloudDropURL)">
      <Output TaskParameter="BlobElements" ItemName="BlobElements" />
    </ParseBlobUrl>

    <PropertyGroup>
      <ChecksumBlobContainerName>%(BlobElements.ContainerName)</ChecksumBlobContainerName>
      <ChecksumBlobAccountName>%(BlobElements.AccountName)</ChecksumBlobAccountName>
    </PropertyGroup>
  </Target>


  <Target Name="CheckIfAllBuildsHavePublished">
    <CheckIfAllBuildsHavePublished AccountKey="$(ArtifactCloudDropAccessToken)"
                                   AccountName="$(ArtifactBlobAccountName)"
                                   ContainerName="$(ArtifactBlobContainerName)"
                                   NugetVersion="$(FullNugetVersion)"
                                   VersionBadgeMoniker="$(VersionBadgeMoniker)">
      <Output TaskParameter="HaveAllBuildsPublished" PropertyName="HaveAllBuildsPublished" />
    </CheckIfAllBuildsHavePublished>
  </Target>

  <Target Name="FinalizeBuild" Condition=" '$(HaveAllBuildsPublished)' == 'True' ">
    <CopyBlobsToLatest AccountName="$(ArtifactBlobAccountName)"
                       AccountKey="$(ArtifactCloudDropAccessToken)"
                       ContainerName="$(ArtifactBlobContainerName)"
                       NugetVersion="$(FullNugetVersion)"
                       Channel="$(Channel)"
                       CommitHash="$(CommitHash)"
                       Coherent="$(Coherent)" />

    <CopyBlobsToLatest AccountName="$(ChecksumBlobAccountName)"
                       AccountKey="$(ChecksumCloudDropAccessToken)"
                       ContainerName="$(ChecksumBlobContainerName)"
                       NugetVersion="$(FullNugetVersion)"
                       Channel="$(Channel)"
                       CommitHash="$(CommitHash)"
                       Coherent="$(Coherent)" />

    <UpdateVersionsRepo BranchName="$(BranchName)"
                        PackagesDirectory="$(PackagesDirectory)"
                        GitHubPassword="$(GITHUB_PASSWORD)"
                        Condition=" '$(GITHUB_PASSWORD)' != '' " />
  </Target>
</Project>
