<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <Target Name="GenerateNuGetPackagesArchive"
            DependsOnTargets="SetupNuGetPackagesArchiveInputsOutputs"
            Inputs="$(Stage2Directory)/sdk/$(SdkVersion)/dotnet.dll"
            Outputs="$(FinalArchive)">
      <ItemGroup>
        <FilesToClean Include="$(NuGetPackagesArchiveProject)/**/*" />
        <FilesToClean Include="$(NuGetPackagesArchiveFolder)/**/*" />
      </ItemGroup>

      <Delete Files="@(FilesToClean)" />
      <RemoveDir Directories="$(NuGetPackagesArchiveProject);$(NuGetPackagesArchiveFolder)" />
      <MakeDir Directories="$(NuGetPackagesArchiveProject);$(NuGetPackagesArchiveFolder)"/>

      <Exec Command="$(DotnetStage2) new" WorkingDirectory="$(NuGetPackagesArchiveProject)" />
      <Exec Command="$(DotnetStage2) restore --packages $(NuGetPackagesArchiveFolder)"
          WorkingDirectory="$(NuGetPackagesArchiveProject)" />

      <Delete Files="$(IntermediateArchive);$(IntermediateArchive).zip" />

      <Message Text="Publishing Archiver" />
      <Exec Command="$(DotnetStage2) publish --output $(ToolsOutputDirectory) --configuration $(Configuration)" 
          WorkingDirectory="$(RepoRoot)/tools/Archiver" />

      <Exec Command="$(ArchiverExe) -a $(IntermediateArchive) $(NuGetPackagesArchiveFolder)" />

      <Copy SourceFiles="$(IntermediateArchive)" DestinationFiles="$(FinalArchive)" />
    </Target>

    <Target Name="SetupNuGetPackagesArchiveInputsOutputs"
            DependsOnTargets="Init">
      <PropertyGroup>
        <NuGetPackagesArchiveProject>$(IntermediateDirectory)/NuGetPackagesArchiveProject</NuGetPackagesArchiveProject>
        <NuGetPackagesArchiveFolder>$(IntermediateDirectory)/NuGetPackagesArchiveFolder</NuGetPackagesArchiveFolder>
        <ArchiverExe>$(ToolsOutputDirectory)/Archiver</ArchiverExe>
        <IntermediateArchive>$(IntermediateDirectory)/nuGetPackagesArchive.lzma</IntermediateArchive>
        <FinalArchive>$(Stage2Directory)/sdk/$(SdkVersion)/nuGetPackagesArchive.lzma</FinalArchive>
      </PropertyGroup>
    </Target>
</Project>